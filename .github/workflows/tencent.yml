name: Tencent Kubernetes Engine

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY_HOST: ccr.ccs.tencentyun.com
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/demo/mywebapp    # <registry>/<namespace>/<repo>
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-mywebapp                            # must be the real TKE cluster ID, e.g. cls-abc123
  DEPLOYMENT_NAME: tke-test
  KUSTOMIZE_DIR: .                                        # set to the folder with your kustomization.yaml
  IMAGE_NAME_IN_KUSTOMIZE: mywebapp                       # must match 'images.name' in kustomization.yaml

permissions:
  contents: read

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Build
      - name: Build Docker image
        run: |
          docker build -t ${TKE_IMAGE_URL}:${GITHUB_SHA} -f docker/Dockerfile .

      # Login to Tencent CCR (host, not full image URL)
      - name: Login TKE Registry
        run: |
          echo "${{ secrets.TKE_REGISTRY_PASSWORD }}" | docker login ${REGISTRY_HOST} \
            -u "${{ secrets.TENCENT_CLOUD_ACCOUNT_ID }}" --password-stdin

      # Push the Docker image to TKE Registry
      - name: Publish
        run: |
          docker push ${TKE_IMAGE_URL}:${GITHUB_SHA}

      # Kustomize 
      
      - name: Set up Kustomize
        run: |
          curl -sSL -o kustomize https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64
          chmod u+x ./kustomize

      # kubeconfig for TKE
      - name: Set up ~/.kube/config for connecting TKE cluster
        uses: TencentCloud/tke-cluster-credential-action@v1
        with:
          secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
          secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
          tke_region: ${{ env.TKE_REGION }}
          cluster_id: ${{ env.TKE_CLUSTER_ID }}

      - name: Switch to TKE context
        run: |
          kubectl config get-contexts
          kubectl config use-context ${TKE_CLUSTER_ID}-context-default

      # Deploy the Docker image to the TKE cluster
      - name: Deploy
        working-directory: ${{ env.KUSTOMIZE_DIR }}
        run: |
          # Replace the image defined in kustomization.yaml
          ./kustomize edit set image ${IMAGE_NAME_IN_KUSTOMIZE}=${TKE_IMAGE_URL}:${GITHUB_SHA}
          ./kustomize build . | kubectl apply -f -
          kubectl rollout status deployment/${DEPLOYMENT_NAME}
          kubectl get services -o wide
defaults:
  run:
  ∫


    
    
