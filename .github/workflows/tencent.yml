name: Tencent Kubernetes Engine

on:
  push:
    branches: ["main"]

env:
  REGISTRY_HOST: ccr.ccs.tencentyun.com
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/demo/mywebapp
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-mywebapp
  DEPLOYMENT_NAME: tke-test
  KUSTOMIZE_DIR: .
  IMAGE_NAME_IN_KUSTOMIZE: mywebapp
  KUBE_NAMESPACE: default   # change to your namespace, e.g. prod

permissions:
  contents: read

jobs:
  setup-build-publish-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # If your Dockerfile does NOT run npm build inside the image,
      # build the Vite app first so 'dist/' exists:
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      - name: Build project (Vite)
        run: npm run build

      - name: Build Docker image
        run: |
          docker build \
            -t ${TKE_IMAGE_URL}:${GITHUB_SHA} \
            -t ${TKE_IMAGE_URL}:latest \
            -f docker/Dockerfile .

      - name: Login TKE Registry
        run: |
          echo "${{ secrets.TKE_REGISTRY_PASSWORD }}" | docker login ${REGISTRY_HOST} \
            -u "${{ secrets.TENCENT_CLOUD_ACCOUNT_ID }}" --password-stdin

      - name: Publish images
        run: |
          docker push ${TKE_IMAGE_URL}:${GITHUB_SHA}
          docker push ${TKE_IMAGE_URL}:latest

      - name: Install Kustomize
        run: |
          curl -sSL -o kustomize \
            https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64
          chmod +x kustomize
          sudo mv kustomize /usr/local/bin/kustomize

      - name: Configure kubeconfig for TKE
        uses: TencentCloud/tke-cluster-credential-action@v1
        with:
          secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
          secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
          tke_region: ${{ env.TKE_REGION }}
          cluster_id: ${{ env.TKE_CLUSTER_ID }}

      - name: Switch to TKE context
        run: |
          kubectl config get-contexts
          kubectl config use-context ${TKE_CLUSTER_ID}-context-default

      - name: Deploy to TKE with Kustomize
        working-directory: ${{ env.KUSTOMIZE_DIR }}
        run: |
          kustomize edit set image ${IMAGE_NAME_IN_KUSTOMIZE}=${TKE_IMAGE_URL}:${GITHUB_SHA}
          kustomize build . | kubectl apply -n ${KUBE_NAMESPACE} -f -
          kubectl rollout status -n ${KUBE_NAMESPACE} deployment/${DEPLOYMENT_NAME}
          kubectl get services -n ${KUBE_NAMESPACE} -o wide
